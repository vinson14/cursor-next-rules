---
description: This rule applies when implementing authentication with Supabase Auth, including sign up, sign in, sign out, session management, or route protection.
alwaysApply: false
---

# Supabase Authentication

## 1. Overview

Supabase Auth provides authentication for personal projects. Use this instead of external providers (like WorkOS) for simpler setups.

## 2. Environment Variables

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

**Note:** `NEXT_PUBLIC_*` variables are safe to expose to the browser.

## 3. Client Setup

### Installation

```bash
pnpm add @supabase/supabase-js @supabase/ssr
```

### Server Client (`@lib/supabase/server.ts`)

Used in Server Components and Server Actions.

```typescript
import { createServerClient } from "@supabase/ssr";
import { cookies } from "next/headers";

export async function createClient() {
    const cookieStore = await cookies();

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return cookieStore.getAll();
                },
                setAll(cookiesToSet) {
                    try {
                        cookiesToSet.forEach(({ name, value, options }) =>
                            cookieStore.set(name, value, options)
                        );
                    } catch {
                        // Called from Server Component, ignore
                    }
                },
            },
        }
    );
}
```

### Browser Client (`@lib/supabase/client.ts`)

Used in Client Components.

```typescript
import { createBrowserClient } from "@supabase/ssr";

export function createClient() {
    return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    );
}
```

## 4. Middleware

Refreshes auth tokens and protects routes. Create `middleware.ts` in your project root.

```typescript
import { createServerClient } from "@supabase/ssr";
import { NextResponse, type NextRequest } from "next/server";

export async function middleware(request: NextRequest) {
    let supabaseResponse = NextResponse.next({ request });

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return request.cookies.getAll();
                },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value }) =>
                        request.cookies.set(name, value)
                    );
                    supabaseResponse = NextResponse.next({ request });
                    cookiesToSet.forEach(({ name, value, options }) =>
                        supabaseResponse.cookies.set(name, value, options)
                    );
                },
            },
        }
    );

    // Refresh session if expired
    const {
        data: { user },
    } = await supabase.auth.getUser();

    // Protect routes (customize as needed)
    const isAuthPage = request.nextUrl.pathname.startsWith("/auth");
    const isProtectedRoute = request.nextUrl.pathname.startsWith("/dashboard");

    if (!user && isProtectedRoute) {
        const url = request.nextUrl.clone();
        url.pathname = "/auth/login";
        return NextResponse.redirect(url);
    }

    if (user && isAuthPage) {
        const url = request.nextUrl.clone();
        url.pathname = "/dashboard";
        return NextResponse.redirect(url);
    }

    return supabaseResponse;
}

export const config = {
    matcher: [
        "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
    ],
};
```

## 5. Auth Actions

### Sign Up

```typescript
"use server";

import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";

export async function signUp(formData: FormData) {
    const supabase = await createClient();

    const { error } = await supabase.auth.signUp({
        email: formData.get("email") as string,
        password: formData.get("password") as string,
    });

    if (error) {
        throw error;
    }

    redirect("/auth/verify-email");
}
```

### Sign In

```typescript
"use server";

import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";

export async function signIn(formData: FormData) {
    const supabase = await createClient();

    const { error } = await supabase.auth.signInWithPassword({
        email: formData.get("email") as string,
        password: formData.get("password") as string,
    });

    if (error) {
        throw error;
    }

    redirect("/dashboard");
}
```

### Sign Out

```typescript
"use server";

import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";

export async function signOut() {
    const supabase = await createClient();
    await supabase.auth.signOut();
    redirect("/");
}
```

### Get Current User

```typescript
import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";

export default async function DashboardPage() {
    const supabase = await createClient();
    const {
        data: { user },
    } = await supabase.auth.getUser();

    if (!user) {
        redirect("/auth/login");
    }

    return <div>Welcome, {user.email}</div>;
}
```

## 6. OAuth Providers (Optional)

### Enable in Supabase Dashboard

1. Go to Authentication → Providers
2. Enable desired providers (Google, GitHub, etc.)
3. Add OAuth credentials

### Sign In with OAuth

```typescript
"use client";

import { createClient } from "@/lib/supabase/client";

export function OAuthButtons() {
    const supabase = createClient();

    const signInWithGoogle = async () => {
        await supabase.auth.signInWithOAuth({
            provider: "google",
            options: {
                redirectTo: `${window.location.origin}/auth/callback`,
            },
        });
    };

    return <button onClick={signInWithGoogle}>Sign in with Google</button>;
}
```

### Auth Callback Route (`app/auth/callback/route.ts`)

```typescript
import { createClient } from "@/lib/supabase/server";
import { NextResponse } from "next/server";

export async function GET(request: Request) {
    const { searchParams, origin } = new URL(request.url);
    const code = searchParams.get("code");
    const next = searchParams.get("next") ?? "/dashboard";

    if (code) {
        const supabase = await createClient();
        const { error } = await supabase.auth.exchangeCodeForSession(code);

        if (!error) {
            return NextResponse.redirect(`${origin}${next}`);
        }
    }

    return NextResponse.redirect(`${origin}/auth/error`);
}
```

## 7. File Structure

```
lib/
└── supabase/
    ├── server.ts         # Server client factory
    └── client.ts         # Browser client factory
app/
├── auth/
│   ├── login/page.tsx    # Login page
│   ├── signup/page.tsx   # Signup page
│   ├── callback/route.ts # OAuth callback handler
│   └── verify-email/page.tsx
└── (protected)/          # Route group for protected pages
    └── dashboard/page.tsx
middleware.ts             # Auth refresh + route protection
```

## 8. Best Practices

| Do                                           | Don't                                  |
| :------------------------------------------- | :------------------------------------- |
| Use `getUser()` to verify auth (server-side) | Trust `getSession()` alone for auth    |
| Use middleware to refresh sessions           | Manually manage auth tokens            |
| Redirect unauthenticated users in middleware | Check auth in every page component     |
| Use Server Actions for auth mutations        | Call auth methods directly from client |
| Handle errors and show user feedback         | Silently fail auth operations          |
